import Link from 'next/link';
import { Button } from '../ui/button';
import {
  CreditCardIcon,
  HeartIcon,
  LogOutIcon,
  Settings2Icon,
  ShoppingBagIcon,
} from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '../ui/dropdown-menu';
import { Avatar, AvatarFallback, AvatarImage } from '../ui/avatar';
import { getAccountsUrl, getLoginUrl } from '@/lib/urls';
import SubmitButton from '../submit-button';
import { auth } from '@protoxyz/auth';
import { signOut } from '@protoxyz/auth/actions';

const defaultActions = [
  {
    label: 'Account Settings',
    href: getAccountsUrl({ path: '/user' }).toString(),
    icon: <Settings2Icon className="h-4 w-4" />,
  },
  {
    label: 'Billing',
    href: '/account/billing',
    icon: <CreditCardIcon className="h-4 w-4" />,
  },
  {
    label: 'Order History',
    href: '/account/orders',
    icon: <ShoppingBagIcon className="h-4 w-4" />,
  },
  {
    label: 'Wishlist',
    href: '/account/wishlist',
    icon: <HeartIcon className="h-4 w-4" />,
  },
  {
    label: 'Recently Viewed',
    href: '/account/recently-viewed',
    icon: <HeartIcon className="h-4 w-4" />,
  },
];

export default async function UserButton({
  mode = 'avatar',
  dashboardUrl,
  actions = defaultActions,
}: {
  mode?: 'button' | 'avatar';
  dashboardUrl?: string;
  actions?: {
    label: string;
    href: string;
    icon?: React.ReactNode;
  }[];
}) {
  const session = await auth();

  if (!session) {
    return (
      <Link href={getLoginUrl()}>
        <Button variant="outline">Login</Button>
      </Link>
    );
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        {mode === 'button' ? (
          <Button variant="outline" className="gap-1">
            <Avatar className="h-8 w-8">
              <AvatarImage src={session.claims?.image ?? ''} />
              <AvatarFallback className="text-xs">
                {session.claims?.name
                  ?.split(' ')
                  .map((w) => w?.[0])
                  .join('')}
              </AvatarFallback>
            </Avatar>
            {session.claims?.name}
          </Button>
        ) : (
          <Avatar className="hover:border-primary h-8 w-8 cursor-pointer border border-transparent border-opacity-25">
            <AvatarImage src={session.claims?.image ?? ''} />
            <AvatarFallback className="text-xs">
              {session.claims?.name
                ?.split(' ')
                .map((w) => w?.[0])
                .join('')}
            </AvatarFallback>
          </Avatar>
        )}
      </DropdownMenuTrigger>
      <DropdownMenuContent className="w-[300px]" align="end">
        <DropdownMenuLabel>
          <Link
            href={dashboardUrl ?? getAccountsUrl({ path: '/user' })}
            className="flex items-center justify-between"
          >
            <div className="text-muted-foreground p-4 text-sm font-light">
              Signed in as
              <br />
              <span className="font-semibold text-black">
                {session.claims?.name}
              </span>
              <br />
              <span className="text-light text-muted-foreground text-xs">
                {session.claims?.email}
              </span>
            </div>
            <Avatar className="h-24 w-24">
              <AvatarFallback>
                {session.claims?.name
                  ?.split(' ')
                  .map((w) => w?.[0])
                  .join('')}
              </AvatarFallback>

              <AvatarImage src={session.claims?.image ?? ''} />
            </Avatar>
          </Link>
        </DropdownMenuLabel>
        <DropdownMenuSeparator />
        {actions?.map((action) => {
          return (
            <DropdownMenuItem key={action.label}>
              <Link href={action.href} className="w-full">
                <Button variant="link" className="gap-1">
                  {action.icon} {action.label}
                </Button>
              </Link>
            </DropdownMenuItem>
          );
        })}
        <DropdownMenuSeparator />
        <DropdownMenuLabel>
          <form action={signOut.bind(null, { redirectTo: '/' })}>
            <SubmitButton
              type="submit"
              variant="secondary"
              className="flex w-full items-center justify-between"
            >
              Logout <LogOutIcon className="h-4 w-4" />
            </SubmitButton>
          </form>
        </DropdownMenuLabel>
        <DropdownMenuSeparator />
        <DropdownMenuLabel className="overflow-hidden rounded-bl-lg rounded-br-lg p-0">
          <Link
            href="https://www.pxyz.dev"
            title="Secured by Protocol"
            target="_blank"
            className=" bg-accent flex w-full items-center justify-center gap-1 p-4 hover:opacity-75"
          >
            <span className="text-muted-foreground text-xs font-light">
              Secured by
            </span>

            <svg
              width="288"
              height="56"
              viewBox="0 0 288 56"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
              className="text-foreground h-4 w-auto"
            >
              <path
                d="M62.032 13.848H72.208C73.648 13.848 74.8 13.88 75.664 13.944C76.56 14.008 77.504 14.152 78.496 14.376C79.52 14.6 80.336 14.936 80.944 15.384C81.584 15.832 82.128 16.44 82.576 17.208C82.992 17.944 83.2 18.872 83.2 19.992V26.472C83.2 29.064 82.192 30.936 80.176 32.088C78.192 33.208 75.248 33.768 71.344 33.768H66.688V45H62.032V13.848ZM71.968 30.84C73.984 30.84 75.6 30.472 76.816 29.736C78.032 29 78.64 27.832 78.64 26.232V20.568C78.64 19.704 78.416 19 77.968 18.456C77.52 17.88 76.88 17.48 76.048 17.256C75.248 17.064 74.576 16.936 74.032 16.872C73.488 16.808 72.768 16.776 71.872 16.776H66.64V30.84H71.968ZM96.319 21.768H100.399V25.56C100.399 24.824 100.719 24.136 101.359 23.496C101.999 22.824 102.815 22.296 103.807 21.912C104.799 21.496 105.775 21.288 106.735 21.288H108.847V24.984H106.447C104.399 24.984 102.911 25.256 101.983 25.8C101.087 26.312 100.639 27.256 100.639 28.632V45H96.319V21.768ZM130.187 45.48C128.139 45.48 126.603 45.4 125.579 45.24C124.555 45.112 123.531 44.808 122.507 44.328C121.451 43.848 120.683 43.08 120.203 42.024C119.723 40.936 119.483 39.48 119.483 37.656V29.592C119.483 28.152 119.659 26.888 120.011 25.8C120.363 24.712 120.827 23.864 121.403 23.256C121.883 22.712 122.603 22.296 123.563 22.008C124.555 21.688 125.563 21.48 126.587 21.384C127.739 21.32 128.939 21.288 130.187 21.288C131.851 21.288 133.099 21.336 133.931 21.432C134.795 21.496 135.707 21.656 136.667 21.912C137.659 22.2 138.427 22.632 138.971 23.208C139.515 23.784 139.979 24.616 140.363 25.704C140.715 26.824 140.891 28.12 140.891 29.592V37.656C140.891 40.376 140.267 42.36 139.019 43.608C138.507 44.12 137.771 44.52 136.811 44.808C135.851 45.096 134.859 45.288 133.835 45.384C132.619 45.448 131.403 45.48 130.187 45.48ZM130.187 42.648C131.531 42.648 132.507 42.616 133.115 42.552C133.723 42.488 134.315 42.312 134.891 42.024C135.467 41.768 135.867 41.352 136.091 40.776C136.347 40.168 136.475 39.336 136.475 38.28V28.872C136.475 27.432 136.299 26.392 135.947 25.752C135.595 25.08 134.987 24.648 134.123 24.456C133.291 24.232 131.979 24.12 130.187 24.12C128.395 24.12 127.067 24.232 126.203 24.456C125.371 24.648 124.779 25.08 124.427 25.752C124.075 26.392 123.899 27.432 123.899 28.872V38.28C123.899 39.336 124.011 40.168 124.235 40.776C124.491 41.352 124.907 41.768 125.483 42.024C126.059 42.312 126.651 42.488 127.259 42.552C127.867 42.616 128.843 42.648 130.187 42.648ZM164.572 45.48C162.588 45.48 161.036 45.272 159.916 44.856C158.796 44.408 157.98 43.672 157.468 42.648C156.988 41.592 156.748 40.12 156.748 38.232V24.6H151.564V21.768H156.748V14.568H161.116V21.768H169.42V24.6H161.116V38.472C161.116 39.624 161.244 40.488 161.5 41.064C161.788 41.64 162.268 42.056 162.94 42.312C163.644 42.536 164.652 42.648 165.964 42.648C166.38 42.648 167.532 42.52 169.42 42.264V45.096C167.788 45.352 166.172 45.48 164.572 45.48ZM191.181 45.48C189.133 45.48 187.597 45.4 186.573 45.24C185.549 45.112 184.525 44.808 183.501 44.328C182.445 43.848 181.677 43.08 181.197 42.024C180.717 40.936 180.477 39.48 180.477 37.656V29.592C180.477 28.152 180.653 26.888 181.005 25.8C181.357 24.712 181.821 23.864 182.397 23.256C182.877 22.712 183.597 22.296 184.557 22.008C185.549 21.688 186.557 21.48 187.581 21.384C188.733 21.32 189.933 21.288 191.181 21.288C192.845 21.288 194.093 21.336 194.925 21.432C195.789 21.496 196.701 21.656 197.661 21.912C198.653 22.2 199.421 22.632 199.965 23.208C200.509 23.784 200.973 24.616 201.357 25.704C201.709 26.824 201.885 28.12 201.885 29.592V37.656C201.885 40.376 201.261 42.36 200.013 43.608C199.501 44.12 198.765 44.52 197.805 44.808C196.845 45.096 195.853 45.288 194.829 45.384C193.613 45.448 192.397 45.48 191.181 45.48ZM191.181 42.648C192.525 42.648 193.501 42.616 194.109 42.552C194.717 42.488 195.309 42.312 195.885 42.024C196.461 41.768 196.861 41.352 197.085 40.776C197.341 40.168 197.469 39.336 197.469 38.28V28.872C197.469 27.432 197.293 26.392 196.941 25.752C196.589 25.08 195.981 24.648 195.117 24.456C194.285 24.232 192.973 24.12 191.181 24.12C189.389 24.12 188.061 24.232 187.197 24.456C186.365 24.648 185.773 25.08 185.421 25.752C185.069 26.392 184.893 27.432 184.893 28.872V38.28C184.893 39.336 185.005 40.168 185.229 40.776C185.485 41.352 185.901 41.768 186.477 42.024C187.053 42.312 187.645 42.488 188.253 42.552C188.861 42.616 189.837 42.648 191.181 42.648ZM225.182 45.48C223.582 45.48 222.414 45.448 221.678 45.384C220.974 45.32 220.158 45.16 219.23 44.904C218.238 44.648 217.47 44.264 216.926 43.752C216.382 43.24 215.918 42.488 215.534 41.496C215.15 40.536 214.958 39.336 214.958 37.896V29.352C214.958 26.76 215.454 24.904 216.446 23.784C216.99 23.144 217.534 22.664 218.078 22.344C218.654 21.992 219.39 21.752 220.286 21.624C221.182 21.496 221.982 21.416 222.686 21.384C223.39 21.32 224.382 21.288 225.662 21.288C227.87 21.288 230.078 21.528 232.286 22.008V25.176C229.726 24.536 227.342 24.216 225.134 24.216C223.47 24.216 222.238 24.344 221.438 24.6C220.67 24.824 220.126 25.256 219.806 25.896C219.518 26.504 219.374 27.448 219.374 28.728V38.232C219.374 39.416 219.534 40.296 219.854 40.872C220.206 41.448 220.814 41.864 221.678 42.12C222.574 42.344 223.886 42.456 225.614 42.456C227.95 42.456 230.286 42.152 232.622 41.544V44.808C230.446 45.256 227.966 45.48 225.182 45.48ZM255.128 45.48C253.08 45.48 251.544 45.4 250.52 45.24C249.496 45.112 248.472 44.808 247.448 44.328C246.392 43.848 245.624 43.08 245.144 42.024C244.664 40.936 244.424 39.48 244.424 37.656V29.592C244.424 28.152 244.6 26.888 244.952 25.8C245.304 24.712 245.768 23.864 246.344 23.256C246.824 22.712 247.544 22.296 248.504 22.008C249.496 21.688 250.504 21.48 251.528 21.384C252.68 21.32 253.88 21.288 255.128 21.288C256.792 21.288 258.04 21.336 258.872 21.432C259.736 21.496 260.648 21.656 261.608 21.912C262.6 22.2 263.368 22.632 263.912 23.208C264.456 23.784 264.92 24.616 265.304 25.704C265.656 26.824 265.832 28.12 265.832 29.592V37.656C265.832 40.376 265.208 42.36 263.96 43.608C263.448 44.12 262.712 44.52 261.752 44.808C260.792 45.096 259.8 45.288 258.776 45.384C257.56 45.448 256.344 45.48 255.128 45.48ZM255.128 42.648C256.472 42.648 257.448 42.616 258.056 42.552C258.664 42.488 259.256 42.312 259.832 42.024C260.408 41.768 260.808 41.352 261.032 40.776C261.288 40.168 261.416 39.336 261.416 38.28V28.872C261.416 27.432 261.24 26.392 260.888 25.752C260.536 25.08 259.928 24.648 259.064 24.456C258.232 24.232 256.92 24.12 255.128 24.12C253.336 24.12 252.008 24.232 251.144 24.456C250.312 24.648 249.72 25.08 249.368 25.752C249.016 26.392 248.84 27.432 248.84 28.872V38.28C248.84 39.336 248.952 40.168 249.176 40.776C249.432 41.352 249.848 41.768 250.424 42.024C251 42.312 251.592 42.488 252.2 42.552C252.808 42.616 253.784 42.648 255.128 42.648ZM279.769 11.4H284.089V45H279.769V11.4Z"
                fill="currentColor"
              />
              <path
                d="M38.2368 26.9611C37.4926 25.2074 36.2564 23.7193 34.698 22.6659C33.9225 22.1423 33.0644 21.7259 32.1435 21.4419C31.2287 21.1518 30.2512 21.0003 29.2422 21.0003C27.9487 21.0003 26.7062 21.2529 25.571 21.7137C25.4761 21.7511 25.388 21.7888 25.3 21.8331C24.278 22.2809 23.3442 22.9117 22.5434 23.6625C22.2848 23.9083 22.039 24.167 21.7925 24.4571C21.3577 24.9555 20.9099 25.5296 20.4744 26.1098C20.3863 26.2292 20.2914 26.3555 20.2034 26.4757C19.9637 26.8034 17.6736 30.1592 17.2701 30.7585C17.0681 31.0609 16.8284 31.4016 16.5697 31.7737C16.513 31.8556 16.4502 31.9443 16.3874 32.0324C15.9581 32.6441 15.4788 33.2877 15.0372 33.8557C14.8166 34.139 14.5955 34.4039 14.4064 34.625C14.2112 34.8517 14.0344 35.0347 13.9081 35.1547C13.366 35.6654 12.7285 36.0818 12.0288 36.3658C11.3284 36.6497 10.5652 36.8074 9.75762 36.8074C9.20263 36.8074 8.66668 36.7316 8.16227 36.593C7.90359 36.5234 7.65101 36.4353 7.4052 36.3281C6.3199 35.8736 5.39282 35.1042 4.74299 34.139C4.4153 33.6536 4.15655 33.1238 3.97983 32.5559C3.80974 31.9879 3.70881 31.3892 3.70881 30.7585C3.70881 29.9195 3.87943 29.131 4.18184 28.4054C4.6426 27.3207 5.41194 26.3998 6.37719 25.7438C6.86255 25.4155 7.39225 25.1635 7.96019 24.9867C8.52752 24.8099 9.12684 24.7096 9.75762 24.7096C10.5652 24.7157 11.3284 24.8672 12.0288 25.1506C12.7285 25.4407 13.366 25.8509 13.9081 26.3616C14.0344 26.4817 14.2112 26.6708 14.4064 26.8919C14.747 27.2892 15.1505 27.7999 15.5546 28.3364C15.7123 28.5508 15.87 28.7651 16.0276 28.9856C16.6331 28.103 17.6926 26.5513 18.2476 25.7499C18.1534 25.6236 18.0585 25.498 17.9642 25.3717C17.7116 25.0495 17.4591 24.7409 17.2072 24.4569C16.9546 24.1668 16.715 23.9081 16.4563 23.6623C15.586 22.8418 14.558 22.1735 13.4288 21.7133C12.2935 21.2526 11.0506 21 9.75762 21C8.41417 21 7.1274 21.2716 5.95458 21.7699C4.20095 22.5079 2.71827 23.7442 1.66489 25.302C1.14136 26.0782 0.725537 26.9417 0.435398 27.8565C0.151506 28.7776 0 29.749 0 30.7586C0 32.1021 0.27102 33.3888 0.763242 34.5555C1.50729 36.3153 2.74356 37.798 4.29526 38.8513C5.07754 39.3749 5.93562 39.7907 6.85646 40.0808C7.77113 40.3648 8.74872 40.5163 9.75769 40.5163C11.0506 40.5163 12.2937 40.2637 13.4289 39.8036C14.558 39.3429 15.5799 38.6745 16.4503 37.8608L16.4564 37.8546C16.7152 37.615 16.9548 37.3495 17.2073 37.0594C17.6422 36.5611 18.09 35.9876 18.5255 35.4073C18.6136 35.2872 18.7084 35.1671 18.7965 35.0475C19.0361 34.7131 22.1714 30.1148 22.4296 29.7428C22.4869 29.6608 22.5497 29.5728 22.6125 29.4841C23.0418 28.8785 23.521 28.2288 23.9627 27.6615C24.1832 27.3775 24.4043 27.1126 24.5935 26.892C24.7888 26.6648 24.9656 26.4818 25.0918 26.3617C25.6338 25.8511 26.2714 25.4408 26.9712 25.1508C27.1418 25.0817 27.3118 25.0252 27.4885 24.9678C28.0435 24.804 28.6299 24.7159 29.2422 24.7097C30.0811 24.7158 30.8758 24.8797 31.5946 25.1889C32.6793 25.6429 33.607 26.4122 34.2562 27.3775C34.5845 27.8635 34.8432 28.3932 35.0194 28.9605C35.1962 29.5284 35.291 30.1278 35.291 30.7585C35.291 31.5975 35.1204 32.3921 34.818 33.1109C34.3572 34.1956 33.5879 35.1233 32.6227 35.7725C32.1373 36.1008 31.6076 36.3596 31.0397 36.5296C30.4785 36.7064 29.873 36.8075 29.2422 36.8075C28.4347 36.8075 27.6714 36.6498 26.9711 36.3659C26.2713 36.0819 25.6337 35.6654 25.0917 35.1548C24.9654 35.0347 24.7886 34.8456 24.5934 34.6251C24.2527 34.234 23.8487 33.7165 23.4452 33.1806C23.2814 32.9662 23.1236 32.7451 22.966 32.5246C22.9155 32.6003 22.865 32.6762 22.8083 32.758C21.7673 34.2845 21.1113 35.2496 20.7521 35.7726C20.8463 35.8989 20.9412 36.019 21.0355 36.1453C21.2881 36.4669 21.5406 36.7761 21.7925 37.0594C22.0388 37.3495 22.2847 37.615 22.5434 37.8546C23.4137 38.6745 24.4418 39.3429 25.5709 39.8036C26.7062 40.2637 27.9486 40.5163 29.2422 40.5163C30.5855 40.5163 31.8724 40.2453 33.039 39.7531C34.7988 39.009 36.2809 37.7727 37.3348 36.2143C37.8578 35.4388 38.2809 34.5808 38.5643 33.6598C38.8484 32.7451 39 31.7676 39 30.7586C39 29.4152 38.729 28.1284 38.2368 26.9611Z"
                fill="currentColor"
              />
            </svg>
          </Link>
        </DropdownMenuLabel>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
